name: Deploy to Aptible Staging

on:
  workflow_run:
    workflows: [ "Run tests" ]
    types: [ completed ]
    branches: [ main ]
  workflow_dispatch:
    inputs: { }

jobs:
  deploy:
    name: Deploy to Aptible Staging
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0

      - name: Install Aptible CLI
        run: curl -sSL https://downloads.aptible.com/cli/install.sh | sh

      - name: Authenticate with Aptible
        env:
          APTIBLE_USERNAME: ${{ secrets.APTIBLE_USERNAME }}
          APTIBLE_PASSWORD: ${{ secrets.APTIBLE_PASSWORD }}
        run: |
          aptible login --email "$APTIBLE_USERNAME" --password "$APTIBLE_PASSWORD"
      - name: Set environment variable in Aptible
        run: |
          aptible config:set \
          GIT_REF="${{ github.event.inputs.branch }}" \
          --app illinois-get-childcare-staging

      - name: Deploy to Aptible
        uses: aptible/aptible-deploy-action@v4
        with:
          type: git
          app: illinois-get-childcare-staging
          environment: illinois-staging
          username: ${{ secrets.APTIBLE_USERNAME }}
          password: ${{ secrets.APTIBLE_PASSWORD }}
      #         Looking for secrets/variables for the application? Check the configuration tab in the Aptible app GUI

      - name: Generate Sentry release name from sha
        id: generate-release
        run: echo "::set-output name=RELEASE::$(git rev-parse HEAD)"

      - name: Create Sentry release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: codeforamerica
          SENTRY_PROJECT: il-gcc
        with:
          environment: staging
          ignore_missing: true

      - name: Announce on Slack when deployed
        uses: ravsamhq/notify-slack-action@v2
        with:
          status: ${{ job.status }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
